﻿<!doctype html>
<!-- The Time Machine GitHub pages theme was designed and developed by Jon Rohan, on Feb 7, 2012. -->
<!-- Follow him for fun. http://twitter.com/jonrohan. Tail his code on http://github.com/jonrohan -->
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <link rel="stylesheet" href="../stylesheets/stylesheet.css" media="screen">
  <link rel="stylesheet" href="../stylesheets/pygment_trac.css">
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
  <script type="text/javascript" src="../javascripts/script.js"></script>

  <title>马文斌@博客</title>
  <meta name="description" content="">

  <meta name="viewport" content="width=device-width,initial-scale=1">

</head>

<body>

  <div class="wrapper">
    <header>
      <h1 class="title">马文斌@博客</h1>
    </header>
    <div id="container">
      <p class="tagline"></p>
      <div id="main" role="main">
        <div class="download-bar">
        <div class="inner">
          <a href="https://github.com/mwb1219" class="code">阅读正文</a>
        </div>
        <span class="blc"></span><span class="trc"></span>
        </div>
        <article class="markdown-body">
		


<!-- Blog Post -->
<!-- Title -->
<h2>
  Zookeeper和Curator-Framework实践系列之： 配置管理
  <div class="post-date"><a href="https://github.com/panxw/panxw.github.com/edit/master/_posts/2014-11-26-Distributed-Message-Passing-Config.md" target="_blank">纠错</a>&nbsp;&nbsp;
	<span class="glyphicon glyphicon-time"></span>
	26 Nov 2014
  </div>
</h2>
<!-- Author -->
<hr>
<p>看过Zookeeper相关文档后都知道它可以实现分布式集群的配置管理，本文以一个简单的实例来演示它是如何实现的并工作的。</p>

<h2>一、Zookeeper情景需要</h2>

<p>情景需要，简单理解为下图：</p>

<p><img src="/images/MessageQueue/messagequeue01.png" alt="&quot;messagequeue01&quot;" /></p>

<p>一个web集群，需要通过zk来控制集群的日志输出级别，比如管理员需要在生产环境下查看一下DEBUG日志，他可以临时将集群的日志输出级别改为DEBUG，获取他想要的信息后还要将级别调回到INFO或者ERROR级别。</p>

<p>今天的主角是Curator-Framework，它的存在使得我们操作ZK变得简单有趣起来！
环境，框架，工具</p>

<pre><code>Zookeeper集群
Zookeeper API
Curator-Framework
Spring-MVC
Logback
Maven + IDEA
</code></pre>

<h2>二、相关配置文件</h2>

<h3>2.1、pom.xml：依赖关系和jetty插件</h3>

<pre><code>&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework&lt;/groupId&gt;
        &lt;artifactId&gt;spring-context&lt;/artifactId&gt;
        &lt;version&gt;3.2.3.RELEASE&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework&lt;/groupId&gt;
        &lt;artifactId&gt;spring-web&lt;/artifactId&gt;
        &lt;version&gt;3.2.3.RELEASE&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework&lt;/groupId&gt;
        &lt;artifactId&gt;spring-webmvc&lt;/artifactId&gt;
        &lt;version&gt;3.2.3.RELEASE&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.zookeeper&lt;/groupId&gt;
        &lt;artifactId&gt;zookeeper&lt;/artifactId&gt;
        &lt;version&gt;3.4.5&lt;/version&gt;
        &lt;exclusions&gt;
            &lt;exclusion&gt;
                &lt;groupId&gt;log4j&lt;/groupId&gt;
                &lt;artifactId&gt;log4j&lt;/artifactId&gt;
            &lt;/exclusion&gt;
            &lt;exclusion&gt;
                &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
                &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;
            &lt;/exclusion&gt;
        &lt;/exclusions&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.curator&lt;/groupId&gt;
        &lt;artifactId&gt;curator-framework&lt;/artifactId&gt;
        &lt;version&gt;2.0.1-incubating&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.curator&lt;/groupId&gt;
        &lt;artifactId&gt;curator-recipes&lt;/artifactId&gt;
        &lt;version&gt;2.0.1-incubating&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
        &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
        &lt;version&gt;1.0.13&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;version&gt;1.7.5&lt;/version&gt;
        &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
        &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.testng&lt;/groupId&gt;
        &lt;artifactId&gt;testng&lt;/artifactId&gt;
        &lt;version&gt;6.8.5&lt;/version&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
&lt;build&gt;
    &lt;finalName&gt;zookeeper-configuration&lt;/finalName&gt;
    &lt;plugins&gt;
        &lt;plugin&gt;
            &lt;groupId&gt;org.mortbay.jetty&lt;/groupId&gt;
            &lt;artifactId&gt;jetty-maven-plugin&lt;/artifactId&gt;
            &lt;version&gt;8.1.7.v20120910&lt;/version&gt;
            &lt;configuration&gt;
                &lt;stopKey&gt;pbase&lt;/stopKey&gt;
                &lt;stopPort&gt;8080&lt;/stopPort&gt;
            &lt;/configuration&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;
</code></pre>

<h3>2.2、web.xml配置</h3>

<pre><code>&lt;web-app&gt;
  &lt;display-name&gt;Archetype Created Web Application&lt;/display-name&gt;
    &lt;context-param&gt;
        &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
        &lt;param-value&gt;
            classpath*:/applicationContext.xml
        &lt;/param-value&gt;
    &lt;/context-param&gt;
    &lt;listener&gt;
        &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;
    &lt;/listener&gt;
    &lt;servlet&gt;
        &lt;servlet-name&gt;springServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;
        &lt;init-param&gt;
        &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
        &lt;param-value&gt;classpath*:/spring-mvc.xml&lt;/param-value&gt;
    &lt;/init-param&gt;
        &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
    &lt;/servlet&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;springServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
&lt;/web-app&gt;
</code></pre>

<h3>2.3、Spring 配置：applicationContext.xml</h3>

<pre><code>&lt;context:component-scan base-package="cn.bg"&gt;
    &lt;context:exclude-filter type="annotation" expression="org.springframework.stereotype.Controller"/&gt;
&lt;/context:component-scan&gt;
&lt;!-- Curator的FactoryBean，Spring启动时创建Curator实例。 --&gt;
&lt;bean id="zookeeperFactoryBean" class="cn.bg.zk.core.ZookeeperFactoryBean" lazy-init="false"&gt;
    &lt;property name="zkConnectionString" value="hadoopmaster:2181"/&gt;
    &lt;!-- 设置zookeeper的事件监听者，本例是一个logback日志级别znode监听器 --&gt;
    &lt;property name="listeners"&gt;
        &lt;list&gt;
            &lt;bean class="cn.bg.zk.configuration.LogbackLevelListener"&gt;
                &lt;constructor-arg value="/zk_test/logbacklevel"/&gt;
            &lt;/bean&gt;
        &lt;/list&gt;
    &lt;/property&gt;
&lt;/bean&gt;
</code></pre>

<h3>2.4、spring-mvc.xml配置</h3>

<pre><code>&lt;context:component-scan base-package="cn.bg"&gt;
    &lt;context:include-filter type="annotation" expression="org.springframework.stereotype.Controller"/&gt;
&lt;/context:component-scan&gt;
&lt;mvc:annotation-driven&gt;&lt;/mvc:annotation-driven&gt;
</code></pre>

<h2>三、Zookeeper配置管理实现相关类</h2>

<h3>3.1、ZookeeperFactoryBean.java</h3>

<p>在Spring Context加载过程中创建Zookeeper链接对像并设置触发监听，通过Curator.</p>

<pre><code>package cn.bg.zk.core;

public class ZookeeperFactoryBean implements FactoryBean&lt;CuratorFramework&gt;, InitializingBean, DisposableBean {

    private Logger logger = LoggerFactory.getLogger(this.getClass());
    private CuratorFramework zkClient;

    //设置Zookeeper启动后需要调用的监听或者，或者需要做的初始化工作。
    public void setListeners(List&lt;IZKListener&gt; listeners) {
        this.listeners = listeners;
    }

    private List&lt;IZKListener&gt; listeners;

    //设置ZK链接串
    public void setZkConnectionString(String zkConnectionString) {
        this.zkConnectionString = zkConnectionString;
    }

    private String zkConnectionString;

    @Override
    public CuratorFramework getObject() {
        return zkClient;
    }

    @Override
    public Class&lt;?&gt; getObjectType() {
        return CuratorFramework.class;
    }

    @Override
    public boolean isSingleton() {
        return true;
    }

    @Override
    public void destroy() throws Exception {
        zkClient.close();
    }

    //创建ZK链接
    @Override
    public void afterPropertiesSet(){
        //1000 是重试间隔时间基数，3 是重试次数
        RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000, 3);
        zkClient = createWithOptions(zkConnectionString, retryPolicy, 2000, 10000);
        registerListeners(zkClient);
        zkClient.start();
    }


    /**
     * 通过自定义参数创建
     */
    public CuratorFramework  createWithOptions(String connectionString, RetryPolicy retryPolicy, int connectionTimeoutMs, int sessionTimeoutMs)
    {
        return CuratorFrameworkFactory.builder()
                .connectString(connectionString)
                .retryPolicy(retryPolicy)
                .connectionTimeoutMs(connectionTimeoutMs)
                .sessionTimeoutMs(sessionTimeoutMs)
                .build();
    }        

    //注册需要监听的监听者对像. 
    private void registerListeners(CuratorFramework client){
        client.getConnectionStateListenable().addListener(new ConnectionStateListener() {
            @Override
            public void stateChanged(CuratorFramework client, ConnectionState newState) {
                logger.info("CuratorFramework state changed: {}", newState);
                if(newState == ConnectionState.CONNECTED || newState == ConnectionState.RECONNECTED){
                    for(IZKListener listener : listeners){
                        listener.executor(client);
                        logger.info("Listener {} executed!", listener.getClass().getName());
                    }
                }
            }
        });

        client.getUnhandledErrorListenable().addListener(new UnhandledErrorListener() {
            @Override
            public void unhandledError(String message, Throwable e) {
                logger.info("CuratorFramework unhandledError: {}", message);
            }
        });
    }
}
</code></pre>

<h3>3.2、监听事件接口：IZKListener</h3>

<p>所有需要在ZK客户端链接成功后需要做的事件，需要实现这个接口，由上面的ZookeeperFactoryBean统一调度。</p>

<pre><code>package cn.bg.zk.core;

import org.apache.curator.framework.CuratorFramework;

public interface IZKListener {
    void executor(CuratorFramework client);
}
</code></pre>

<h3>3.3、Logback监听实现</h3>

<p>这里主要用到Curator的NodeCache类，它的主要功能是用来监听znode本身的变化，并可以获取当前值，而且会自动重复监听，简化了原生API开发的繁琐过程。</p>

<pre><code>package cn.bg.zk.configuration;

public class LogbackLevelListener implements IZKListener {

    //获取logback实例
    Logger log = (Logger) LoggerFactory.getLogger(this.getClass());

    private String path;

    //Logback日志级别ZNode
    public LogbackLevelListener(String path) {
        this.path = path;
    }

    @Override
    public void executor(CuratorFramework client) {

        //使用Curator的NodeCache来做ZNode的监听，不用我们自己实现重复监听
        final NodeCache cache = new NodeCache(client, path);
        cache.getListenable().addListener(new NodeCacheListener() {
            @Override
            public void nodeChanged() throws Exception {

                byte[] data = cache.getCurrentData().getData();

                //设置日志级别
                if (data != null) {
                    String level = new String(data);
                    Logger logger = (Logger) LoggerFactory.getLogger("root");
                    Level newLevel = Level.fromLocationAwareLoggerInteger(Integer.parseInt(level));
                    logger.setLevel(newLevel);
                    System.out.println("Setting logback new level to :" + newLevel.levelStr);
                }
            }
        });
        try {
            cache.start(true);
        } catch (Exception e) {
            log.error("Start NodeCache error for path: {}, error info: {}", path, e.getMessage());
        }
    }
}
</code></pre>

<h3>3.4、通过WEB端查看当前日志级别</h3>

<p>写一个controller来读取logback的日志级别：MainController.java</p>

<pre><code>package cn.bg.controller;

@Controller
public class MainController {

    @RequestMapping("/")
    @ResponseBody
    public String logbackLevel() throws Exception {
        Logger logger = (Logger) LoggerFactory.getLogger("root");
        String levelStr = logger.getLevel().levelStr;
        return levelStr;
    }

}
</code></pre>

<h2>四、运行</h2>

<p>在ZK集群端启动zkCli创建/zk_test/logbacklevel的znode，设置值为10，或20在控制台来查看logback的日志输出情况，logback日志级别数据表示如下：</p>

<pre><code>TRACE_INT = 0
DEBUG_INT = 10
INFO_INT = 20
WARN_INT = 30
ERROR_INT = 40
</code></pre>

<p>到此就实现了一个简单的ZK配置管理情境，有了Curator-Framework后一切变的简单起来，我们主要精力只要解决业务相关的的需要，而ZK相关的实现由Curator来解决。</p>

<br/>
<div style="margin-top:10px;margin-bottom:10px">
  
  <span class="next">
    上篇：
    <a href="/2014/11/Distributed-Message-Passing.html">
      Zookeeper和Curator-Framework实践之：分布式消息队列
    </a>
  </span>
   
  
  <span class="prev">
    下篇：
    <a href="/2014/11/Distributed-Message-Passing-Frame.html">
      Curator-Framework开源Zookeeper快速开发框架介绍
    </a>
  </span>
  
</div>
<hr>
<!-- Blog Comments -->
<div class="media">
    <!-- UY BEGIN -->
  <div id="uyan_frame">
  </div>
  <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=1511840">
  </script>
  <!-- UY END --> 
</div>

        </article>
      </div>
    </div>
    <footer>
      <div class="owner">

      <p><a href="https://github.com/mwb1219" class="avatar"><img src="https://avatars1.githubusercontent.com/u/9292203?v=3&amp;s=60" width="48" height="48"></a>View <a href="https://github.com/mwb1219">mwb1219</a> on <a href="https://www.github.com">GitHub</a></p>

      </div>
      <div class="creThis page generated using <a href="http://pages.github.com/">GitHub Pages</a><br>theme by <a href="https://twitter.com/jonrohan/">Jon Rohan</a>i>

</ul></small>
      </div>
    </footer>
  </div>
  <div class="current-section">
    <a href="#top">Scroll to top</a>
    <a href="https://github.com/mwb1219/mwb1219.github.io/tarball/master" class="tar">tar</a><a href="https://github.com/mwb1219/mwb1219.github.io/zipball/master" class="zip">zip</a><a href="" class="code">source code</a>
    <p class="name"></p>
  </div>
  
</body>
</html>